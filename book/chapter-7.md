In the last chapter, we added all data for the signup process, but we need to generate the new email every time to make our test cases pass. In this chapter, we will see how to generate new emails and how to create an organization in AceInvoice.

Before moving further, let's give ourself a small break and grab a coffee as we will be covering lots of new ideas in this chapter

## Creating a unique email

For this purpose, we will be using JavaScript's inbuild method of Math library called `Random()`. This method generates a random number every time called, we will attach the number generated by the method to the email as follows

```js
`test${Math.random()}@webdriverio.com`
```

With this, we will have a new email every time.

Now add a password and confirmation password with `setValue` method and click the submit button and sign up.

Don't forget to print the email to console as this will be useful for our further test cases.

## Checking page after signup

Now we can make an assertion for checking header on the signup page, but we might not get the *Set Preferences* page right after we click the submit button. So, we will have to wait for some time till *Set Preferences* page renders.
At this point, we will use `pause()` command that webdriverio provides us like.

We are using `moveToObject()` command to move the mouse to the specified element when the element is not visible.

```js
browser.pause(500);
```

So our final program may look like this

```js
const assert = require('assert');

describe('AceInvoice Signup', () => {
  it('URL has sign_up and qa.aceinvoice.com as a server address', () => {
    browser.url('./');
    browser.moveToObject('//strong[contains(text(),"Sign Up")]');
    browser.pause(500);
    browser.click('//strong[contains(text(),'Sign Up')]');

    var url = browser.getUrl();
    assert.equal(url, 'https://qa.aceinvoice.com/sign_up');
  });

  it('Navigates to password page after adding an valid email', () => {
    browser.setValue('input[name="email"]', `test${Math.random()}@webdriverio.com`);
    browser.click('.btn.btn-primary');
    browser.pause(500);

    var passwordInputHeight = browser.getCssProperty('input[name="password"]', 'height');
    assert.notEqual(passwordInputHeight.parsed.value, 0);
  });

  it('Creates a user with the email id and password', () => {
    browser.setValue('input[name="password"]', 'welcome');
    browser.setValue('input[name="password_confirmation"]', 'welcome');
    browser.click('.btn.btn-primary');
    browser.pause(500);
    var headerText = browser.getText('.page-header-left');
    assert.equal(headerText, 'Basic details\nAdd your details and preferences.');
  });
});
```

## Creating preferences

Now as we are on preferences page let's add the details and proceed further. Set value to the first name and last name field.

At this moment we may get an `element with a specified selector is not found`. That's because the browser is still loading the page when we are trying to access an element to set a value. We can use the `pause` command like before, but let's take a look at another method which we will call on the element.

First, select the element and then call `waitForVisible(#timeout)` on that element, something similar as shown below

```js
$("input[name='user[first_name]']").waitForVisible(3000);
```

Next, setting a value to option field is a bit confusing here. `browser` object does not have a direct method to select an option. To select an option we need to save element in some variable first and then call `selectByAttribute` method on that element shown as below.

```js
var timezoneSelector = $("select[name='user[time_zone]']");
timezoneSelector.selectByAttribute('value', 'Mumbai');
```

At this moment as well, it is likely that we will end up getting error and method `waitForVisible` won't work here. Any idea why? Right now element is visible but the options in that list are not loaded yet. We have to wait until those options are available to select.

Let's take a look at another method called `waitUntil`. This method takes a function as an argument and other optional arguments are timeout, error message and interval.

We will pass an arrow function here to simply check the text length of the select options. If the length is greater than 100, browser will continue. Interval parameter is optional here and is a way to tell after how much time browser should check the condition again, the default value is 500ms. Let's add that call by

```js
browser.waitUntil(() => $("select[name='user[time_zone]']").getText().length > 100, 3000);
```
To know more about the webdriverio commands, refer : http://v4.webdriver.io/api/action/moveToObject.html

Moving ahead if we want to change the DateTime format and start of the week go ahead and add the code for same and click submit and add code to check if server redirected us to the create organization page same way we did for the preferences page.

## Creating an organization

Now as the last step we need to give the details for the organization to continue. Set the value for name field and email field and click submit. After creating an organization we will be redirected to the team page. So there we will check the name is what we have entered while creating preferences.

This is the final code for this test case which should look like

```js
const assert = require('assert');

describe('AceInvoice Signup', () => {
  it('URL has sign_up and qa.aceinvoice.com as a server address', () => {
    browser.url('./');
    browser.moveToObject('//strong[contains(text(),'Sign Up')]');
    browser.pause(500);
    browser.click('//strong[contains(text(),'Sign Up')]');

    var url = browser.getUrl();
    assert.equal(url, 'https://qa.aceinvoice.com/sign_up');
  });

  it('Navigates to password page after adding an valid email', () => {
    browser.setValue('input[name="email"]', `test${Math.random()}@webdriverio.com`);
    browser.click('.btn.btn-primary');
    browser.pause(500);

    var passwordInputHeight = browser.getCssProperty('input[name="password"]', 'height');
    assert.notEqual(passwordInputHeight.parsed.value, 0);
  });

  it('Creates a user with the email id and password', () => {
    browser.setValue('input[name="password"]', 'welcome');
    browser.setValue('input[name="password_confirmation"]', 'welcome');
    browser.click('.btn.btn-primary');
    browser.pause(500);
    var headerText = browser.getText('.page-header-left');
    assert.equal(headerText, 'Basic details\nAdd your details and preferences.');
  });

  it('Create preferences', () => {
    $("input[name='user[first_name]']").waitForVisible(5000);
    browser.setValue("input[name='user[first_name]']", 'test');
    browser.setValue("input[name='user[last_name]']", 'webdriverio');

    $("select[name='user[time_zone]']").waitForVisible(2000);
    browser.waitUntil(() => $("select[name='user[time_zone]']").getText().length > 1000, 3000);
    var timezoneSelector = $("select[name='user[time_zone]']");
    timezoneSelector.selectByAttribute('value', 'Mumbai');

    browser.click('//input[@id="%m/%d/%Y"]/../div[1]');

    browser.click('//input[@id="Monday"]/../div[1]');

    browser.click("//input[@name='user[terms_of_service_accepted]']/../div[1]");

    browser.click('.btn.btn-primary');

    $("input[name='name']").waitForVisible(3000);
    const createOrgHeader = browser.getText('.page-header-left');
    assert.equal(createOrgHeader, 'Create your organization\nTo continue please enter your organization details, you can also create multiple organizations.');
  });

  it('Creates an organization', () => {
    $("input[name='name']").waitForVisible(3000);
    browser.setValue("input[name='name']", 'WebdriverIO');
    browser.click(".btn.btn-primary");
    browser.pause(500);
    $('.card').waitForVisible(3000);
    const name = browser.getText('.card');
    assert.equal(name, 'This will be the default due date period for all the invoices. It can be changed while creating an invoice.');
  });
});
```

Run the test now with the `npm test` and we will see that webdriver is creating a user and organization for us.

## Next steps

Right now we are using assertion from Node and there are not more assertions to go ahead with. For this purpose, we will integrate the chai which is assertion rich library. Take a look [here](https://www.chaijs.com/).

Also, we are repeating our code too much. DRY(Don't repeat yourself) is considered to be a good programmer practice. In coming chapters, we will overcome this flaw in our program.

Before moving on to the next chapter try some negative flow for the signup process.
