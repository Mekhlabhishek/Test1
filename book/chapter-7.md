# Setting Preferences

In the last chapter, we added all data for the signup process, but we need to generate the new email every time to make our test cases pass. In this chapter, we will see how to generate new emails and how to create an organization in AceInvoice.

Before moving further, give yourself a small break and grab a coffee as we will covering lots of new ideas in this chapter

## 7.1 Creating a unique email

For this purpose, we will be using the JavaScripts inbuild method of Math library called `Random()`. This method generates a random number every time called, we will attach the number generated by the method to the email as follows

```
`test${Math.random()}@webdriverio.com`
```

With this, we will have a new email every time.

Now add a password and confirmation password with `setValue` method and click a submit button and sign up.

Don't forget to print the email to console as this will be useful for our further test cases.

## 7.2 Checking page after signup

Now you can make an assertion for checking header on the signup page, but we might not get the set preferences page right after we click the submit button we have to wait for sometime till set preferences page renders.
At this point, we will use `pause()` command that webdriverio provides us like.

```
browser.pause(500);
```

So your final program may look like this

```
const assert = require('assert');

describe('AceInvoice Signup', () => {
  it('URL has sign_up and staging.aceinvoice.com as a server address', () => {
    browser.url('./');
    browser.click('.signup-button.border-radius-lg');

    var url = browser.getUrl();
    assert.equal(url, 'https://staging.aceinvoice.com/sign_up');
  });

  it('Navigates to password page after adding an valid email', () => {
    browser.setValue('input[name="email"]', `test${Math.random()}@webdriverio.com`);
    browser.click('.btn.btn-primary');

    var passwordInputHeight = browser.getCssProperty('input[name="password"]', 'height');
    assert.notEqual(passwordInputHeight.parsed.value, 0);
  });

  it('Creates a user with the email id and password', () => {
    browser.setValue('input[name="password"]', 'welcome');
    browser.setValue('input[name="password_confirmation"]', 'welcome');
    browser.click('.btn.btn-primary');
    browser.pause(500);
    var headerText = browser.getText('.page-header-left');
    assert.equal(headerText, 'Enter your Preferences');
  });
});
```

## 7.3 Creating preferences

Now as we are on preferences page let's add the details and proceed further. Set value to the first name and last name field.

At this moment you may get an `element with a specified selector is not found`. That's because a browser is still loading the page when we are accessing an element to set a value. You can use the `pause` command like before, but let's take a look at another method which we will call on the element.

First, select the element and then call `waitForVisible(#timeout)` on that element, something similar as shown below

```
$("input[name='user[first_name]']").waitForVisible(3000);
```

Next, setting a value to option field is a bit confusing here. `browser` object does not have a direct method to select an option. To select an option we need to save element in some variable first and then call `selectByAttribute` method on that element shown as below.

```
var timezoneSelector = $("select[name='user[time_zone]']");
timezoneSelector.selectByAttribute('value', 'Mumbai');
```

At this moment as well it is likely that you will end up getting error and method `waitForVisible` won't work here. Any idea why? Right now element is visible but the options in that list are not loaded yet. We have to wait until those options are available to select.

Let's take a look at another method called `waitUntil`. This method takes a function as an argument and other optional arguments are timeout, error message and interval.

We will pass an arrow function here to simply check the text length of the select options. If a length is greater than 100 then the browser will continue. Interval parameter is optional here and is a way to tell after how many time browser should check the condition again, a default value is 500ms. Let's add that call by

```
browser.waitUntil(() => $("select[name='user[time_zone]']").getText().length > 1000, 3000);
```

Moving ahead if you want to change the DateTime format and start of the week go ahead and add the code for same and click submit and add code to check if server redirected us to the create organization page same way we did for the preferences page.

## 7.4 Creating an organization

Now as the last step we need to give the details for the organization to continue. Set the value for name field and email field and click submit. After creating an organization we will be redirected to the team page. So there we will check the name is what we have entered while creating preferences.

This is the final code for test case which should look like

```
const assert = require('assert');

describe('AceInvoice Signup', () => {
  it('URL has sign_up and staging.aceinvoice.com as a server address', () => {
    browser.url('./');
    browser.click('.signup-button.border-radius-lg');

    var url = browser.getUrl();
    assert.equal(url, 'https://staging.aceinvoice.com/sign_up');
  });

  it('Navigates to password page after adding an valid email', () => {
    browser.setValue('input[name="email"]', `test${Math.random()}@webdriverio.com`);
    browser.click('.btn.btn-primary');

    var passwordInputHeight = browser.getCssProperty('input[name="password"]', 'height');
    assert.notEqual(passwordInputHeight.parsed.value, 0);
  });

  it('Creates a user with the email id and password', () => {
    browser.setValue('input[name="password"]', 'welcome');
    browser.setValue('input[name="password_confirmation"]', 'welcome');
    browser.click('.btn.btn-primary');
    browser.pause(500);
    var headerText = browser.getText('.page-header-left');
    assert.equal(headerText, 'Enter your Preferences');
  });

  it('Create preferences', () => {
    $("input[name='user[first_name]']").waitForVisible(5000);
    browser.setValue("input[name='user[first_name]']", 'test');
    browser.setValue("input[name='user[last_name]']", 'webdriverio');

    browser.waitUntil(() => $("select[name='user[time_zone]']").getText().length > 1000, 3000);
    var timezoneSelector = $("select[name='user[time_zone]']");
    timezoneSelector.selectByAttribute('value', 'Mumbai');

    var dateSelector = $("select[name='user[date_format]']");
    dateSelector.selectByAttribute('value', '%m/%d/%Y');

    var startSelector = $("select[name='user[start_of_week]']");
    startSelector.selectByAttribute('value', 'monday');
    browser.click('.btn.btn-primary');

    $("input[name='name']").waitForVisible(3000);
    const createOrgHeader = browser.getText('.page-header-left');
    assert.equal(createOrgHeader, 'Add New Organization');
  });

  it('Creates an organization', () => {
    $("input[name='name']").waitForVisible(3000);
    browser.setValue("input[name='name']", 'WebdriverIO');
    browser.setValue("input[name='email']", 'test2@webdriverio.com');
    browser.click(".btn.btn-primary");
    $('.sorting_1').waitForVisible(3000);
    const name = browser.getText('.sorting_1');
    assert.equal(name, 'test webdriverio');
  });
});
```

Run the test now with the `npm test` you will see that webdriver is creating a user and organization for us.

## 7.5 Next steps

Right now we are using assertion from Node and there are not more assertions to go ahead with. For this purpose, we will integrate the chai which is assertion rich library. Take a look [here](https://www.chaijs.com/).

Also, we are repeating our code too much. DRY(Don't repeat yourself) is considered to be a good programmer practice. In coming chapters, we will overcome this flaw in our program.

Before moving on to the next chapter try some negative flow for the signup process.
